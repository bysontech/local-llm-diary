## FILE: playbook/IMPLEMENTATION_TASK/cycle-06.md

# IMPLEMENTATION TASK – Cycle 6  
**全文把握型ルールベース要約の実装**

---

## 目的
現在の要約が「冒頭文の切り取り」になっているため、  
**日記全文を読み、重要な内容を抽出した要約**を生成できるようにする。

- 外部通信なし
- 依存追加なし
- 端末性能差に強い
- 既存フロー（保存・編集・要約ON/OFF・summaryStatus）を壊さない

---

## スコープ

### Must（必須）
- ルールベース要約を「全文スキャン型」に変更
- 文分割 → 文スコアリング → 上位文抽出 → 要約生成
- 1〜3文、合計文字数上限あり
- 既存の `summaryStatus` を維持
- 失敗時もアプリは落ちない

### Must NOT（やらない）
- WebGPU / ブラウザ内LLMの導入
- 外部API送信
- 新規ライブラリ追加
- UI変更（表示文言は必要最小限のみ）

---

## 実装対象ファイル（想定）

- `src/llm/rule-based.ts`
  - 要約ロジック本体を置き換える
- （必要に応じて）
  - `src/domain/summary.ts`  
    → 文分割・スコアリングを純関数として切り出し

※ DB / UI / 設定の構造は変更しない

---

## 実装方針（詳細）

### 1. 文分割
- 区切り文字：
  - `。` `！` `？`
  - 改行（`\n`）
- 空行は段落境界として扱う
- トリム後、空文字は除外

---

### 2. 文スコアリング（加点方式）

各文にスコアを付ける（例）：

#### 文長
- 15〜80文字：+2
- 5〜14文字：+1
- 80文字超：+0 or -1

#### キーワード加点（例）
- 感情・思考：  
  `思う / 感じる / 不安 / 嬉しい / 疲れた / 楽しい`
- 行動・決断：  
  `決めた / やった / できた / 失敗 / 反省 / 改善`
- 時間・未来：  
  `今日 / 明日 / 来週 / 予定`

含まれていれば +1〜2（合計上限あり）

#### 構造的加点
- 段落先頭文：+1（冒頭固定にならないよう控えめ）

#### 情報密度
- 数字・時刻・英数字を含む：+1

---

### 3. 重複回避（軽量）
- すでに選ばれた文と  
  **共通単語が多い文はスキップ**
- 厳密な類似度計算は不要（includesベースでOK）

---

### 4. 要約生成
- スコア上位から文を選択
- 最大 1〜3 文
- 合計文字数 140〜220 文字以内
- 超える場合は文数を減らす

---

## summaryStatus の扱い

- 要約ON：
  - 成功 → `done`
  - 例外発生 → `failed`
- 要約OFF：
  - `none`
  - summary は空 or 未保存（既存方針に合わせる）

---

## 動作確認手順

### 基本
1. 長文（5段落以上）の日記を作成
2. 保存後、要約が冒頭以外の内容も含んでいること
3. 編集 → 再保存 → 要約が再生成されること

### 短文
4. 1〜2文の日記でも要約が壊れないこと

### 設定連携
5. 要約OFF → 保存 → 要約が生成されない
6. ONに戻す → 新規作成で要約生成

### 非機能
7. オフライン状態で同様に動作
8. console.log に本文・要約が出ていない

---

## 完了条件（DoD）
- [ ] 冒頭切り取りではない要約になっている
- [ ] 長文・短文の両方で破綻しない
- [ ] 既存機能（検索・編集・削除・PWA・export/import）が壊れていない
- [ ] 外部通信なし・依存追加なし

---

## 次サイクルへの布石（メモ）
- このロジックを LLM要約のフォールバックとして再利用可能
- 文スコアリング結果を将来の「感情タグ」や「週/月要約」に流用できる