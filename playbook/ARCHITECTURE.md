# ARCHITECTURE.md

## 1. 概要

本ドキュメントは「プライバシー重視の日記・感情ログ」PWAのMVP設計を定義する。すべてのデータ保存とAI推論は端末内で完結し、日記本文が外部サーバーへ送信されることはない。3〜4週間でMust要件を満たす最小構成を目指す。

---

## 2. MVPのシステム境界

### 端末内で完結するもの
- 日記エントリの入力・編集・削除
- IndexedDBへのデータ永続化
- ローカルLLMまたはルールベースによる要約生成
- 日付検索・一覧表示
- PWAとしてのオフライン動作

### 外部に出ないもの（明示）
- 日記本文
- 要約テキスト
- 感情タグ・メタデータ
- ユーザーの利用履歴

### 外部通信が発生する箇所（限定）
- 初回アクセス時のアプリ配信（Cloudflare Pages）
- PWAアセットのキャッシュ更新
- （オプション）WebGPU用モデルファイルの初回ダウンロード

---

## 3. 画面 / ユーザーフロー（最小）

### 画面一覧

| 画面名 | 役割 | 備考 |
|--------|------|------|
| 一覧 | 日付順のエントリ一覧表示 | デフォルト画面 |
| 新規作成 | 日記入力フォーム | 保存時に要約トリガー |
| 編集 | 既存エントリの編集 | 保存時に要約再生成 |
| 詳細表示 | 単一エントリの閲覧 | 本文＋要約表示 |
| 設定 | MVP最小設定 | 要約ON/OFF、データ削除 |

### 基本フロー

```
[一覧] → [新規作成] → 保存 → [一覧]
           ↓
       要約生成（非同期）
           ↓
       [詳細表示] で要約確認
```

### MVP最小設定項目
- 要約機能の有効/無効
- 全データ削除（リセット）

---

## 4. データモデル（IndexedDB）

### エンティティ定義

```typescript
// Entry: 日記エントリ
interface Entry {
  id: string           // UUID v4
  date: string         // ISO 8601 日付 (YYYY-MM-DD)
  body: string         // 本文
  summary?: string     // 要約（生成済みの場合）
  summaryStatus: 'none' | 'pending' | 'done' | 'failed'
  tags?: string[]      // 感情タグ（Should）
  createdAt: number    // Unix timestamp (ms)
  updatedAt: number    // Unix timestamp (ms)
}

// Settings: アプリ設定
interface Settings {
  key: string          // 設定キー
  value: unknown       // 設定値
}
```

### キー設計・インデックス方針

```typescript
// Dexie スキーマ定義
db.version(1).stores({
  entries: 'id, date, createdAt, updatedAt, summaryStatus',
  settings: 'key'
})
```

| インデックス | 用途 |
|-------------|------|
| `id` | 主キー（UUID） |
| `date` | 日付での絞り込み・ソート |
| `createdAt` | 作成日順ソート |
| `summaryStatus` | 要約未処理エントリの抽出 |

### 全文検索の扱い（Should）
- MVPでは `body` フィールドの `includes()` による簡易検索
- パフォーマンス問題が顕在化した場合、以下を検討：
  - Dexie の全文検索アドオン
  - 別途転置インデックステーブル
- MVP後に要検討とし、初期実装には含めない

---

## 5. ローカルLLM要約の設計

### 実装方式の比較

#### 方式1: ブラウザ内推論（WebGPU / WASM）

| 項目 | 内容 |
|------|------|
| 必要な前提条件 | WebGPU対応ブラウザ、十分なVRAM/メモリ |
| 対応ブラウザ/端末 | Chrome 113+, Edge 113+（デスクトップ中心）、Safari 18+（制限あり） |
| 性能の目安 | 小型モデル（~1B）で数秒〜十数秒/要約 |
| 実装難易度 | 中〜高（transformers.js / onnxruntime-web 利用） |
| MVPでの採用可否 | **条件付き採用可**（対応端末限定、フォールバック必須） |

#### 方式2: 端末ローカルの別プロセス連携

| 項目 | 内容 |
|------|------|
| 必要な前提条件 | ユーザーが別途ローカルランタイム（Ollama等）を起動 |
| 対応ブラウザ/端末 | ランタイムがサポートするOS（Windows/macOS/Linux） |
| 性能の目安 | モデル依存、7Bクラスでも数秒〜十数秒 |
| 実装難易度 | 低〜中（localhost HTTP通信） |
| MVPでの採用可否 | **不採用**（ユーザーへのセットアップ負担大、MVP外） |

#### 方式3: ルールベース要約（フォールバック）

| 項目 | 内容 |
|------|------|
| 必要な前提条件 | なし |
| 対応ブラウザ/端末 | 全ブラウザ |
| 性能の目安 | 即時（数十ms） |
| 実装難易度 | 低 |
| MVPでの採用可否 | **採用（フォールバック必須）** |

### MVP採用方針

```
優先度1: ルールベース要約（全端末で動作保証）
優先度2: WebGPU推論（対応端末のみ、ユーザーオプトイン）
```

- MVPではルールベース要約をデフォルトとし、必ず動作する状態を保証
- WebGPU対応端末では、設定画面でLLM要約を有効化可能（オプション）
- 方式2（ローカルランタイム連携）はMVP後に検討

### ルールベース要約の実装方針
- 文字数に応じた先頭抽出（例：本文の先頭100〜200文字）
- 段落区切りを考慮した要約
- キーワード抽出（頻出語、感情語辞書マッチ）

### 要約トリガー
- **保存時**（デフォルト）: エントリ保存後に非同期で要約生成
- 手動トリガー: 詳細画面から再生成ボタン
- バッチ処理はMVP後

### 推論が重い場合のUX
- プログレス表示: 要約生成中はスピナー + 「要約中...」表示
- キャンセル: 詳細画面を離れた場合は中断（結果破棄）
- タイムアウト: 30秒でフォールバックに切り替え
- 要約なしでも成立: `summaryStatus: 'none'` でも一覧・詳細表示は正常動作

### 端末性能差への対応
- WebGPU非対応 → ルールベースにフォールバック
- 推論失敗 → `summaryStatus: 'failed'` を記録、ルールベース結果を表示
- メモリ不足 → エラーハンドリングでフォールバック

---

## 6. 非機能（最低限）

### 性能

| 指標 | 目標 |
|------|------|
| 初回ロード（キャッシュなし） | 3秒以内（3G回線想定） |
| 一覧表示 | 100件でも1秒以内 |
| 要約生成（ルールベース） | 即時 |
| 要約生成（WebGPU） | 30秒以内、超過時フォールバック |

### オフライン対応（PWAキャッシュ戦略）

```javascript
// vite-plugin-pwa 設定方針
{
  registerType: 'prompt',  // 更新時にユーザー確認
  workbox: {
    globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
    runtimeCaching: [
      {
        urlPattern: /^https:\/\/cdn\.jsdelivr\.net\/.*/i,  // LLMモデル等
        handler: 'CacheFirst',
        options: {
          cacheName: 'external-assets',
          expiration: { maxEntries: 10, maxAgeSeconds: 60 * 60 * 24 * 30 }
        }
      }
    ]
  }
}
```

- App Shell: CacheFirst
- モデルファイル（使用時）: CacheFirst + 長期キャッシュ
- 更新通知: ユーザーに確認後リロード

### データ保護
- ローカル保存前提、サーバーへの永続化なし
- バックアップ: MVP外（Could）
- IndexedDB破損対策: MVP後に検討

### ログ方針
- 日記本文・要約をログ出力しない
- エラーログには `entryId` のみ記録（本文は含めない）
- 開発時の `console.log` は本番ビルドで除去

---

## 7. セキュリティ / プライバシー

### 外部送信禁止を担保する設計

```
通信が発生する箇所:
├── Cloudflare Pages: アプリ配信（静的ファイルのみ）
├── CDN: LLMモデルファイル（オプション、初回のみ）
└── その他: なし
```

- `fetch` / `XMLHttpRequest` のラッパーは不使用
- 外部APIエンドポイントへの通信コードを含めない
- コードレビュー時に通信箇所を重点確認

### CSP（Content Security Policy）

```html
<!-- index.html または Cloudflare Pages ヘッダー -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'wasm-unsafe-eval';
  style-src 'self' 'unsafe-inline';
  connect-src 'self' https://cdn.jsdelivr.net;
  img-src 'self' data:;
  font-src 'self';
  object-src 'none';
  base-uri 'self';
  form-action 'self';
">
```

- `connect-src`: CDN（モデルファイル用）のみ許可
- `wasm-unsafe-eval`: WASM実行に必要
- 外部サービスへの通信は明示的に制限

### 依存ライブラリ追加時の判断基準

| 判断項目 | 基準 |
|----------|------|
| 必要性 | 自前実装コスト > ライブラリ導入リスク |
| メンテナンス状況 | 直近6ヶ月以内に更新あり |
| 依存の深さ | 推移的依存が過度に多くない |
| セキュリティ履歴 | npm audit で重大な脆弱性なし |
| バンドルサイズ | 目的に対して過大でない |
| 通信有無 | テレメトリ・外部通信を行わないこと |

---

## 8. ディレクトリ構成（提案）

```
src/
├── main.tsx              # エントリーポイント
├── App.tsx               # ルーティング
├── index.css             # グローバルスタイル
├── vite-env.d.ts         # 型定義
│
├── ui/                   # プレゼンテーション層
│   ├── components/       # 共通UIコンポーネント
│   │   ├── Button.tsx
│   │   ├── TextArea.tsx
│   │   └── Spinner.tsx
│   ├── pages/            # ページコンポーネント
│   │   ├── EntryListPage.tsx
│   │   ├── EntryCreatePage.tsx
│   │   ├── EntryEditPage.tsx
│   │   ├── EntryDetailPage.tsx
│   │   └── SettingsPage.tsx
│   └── hooks/            # カスタムフック
│       ├── useEntries.ts
│       └── useSummary.ts
│
├── domain/               # ドメインロジック
│   ├── entry.ts          # Entry型定義・バリデーション
│   └── summary.ts        # 要約ロジック抽象化
│
├── db/                   # データ永続化層
│   ├── index.ts          # Dexie インスタンス
│   ├── entries.ts        # Entry CRUD
│   └── settings.ts       # Settings CRUD
│
├── llm/                  # ローカルLLM層
│   ├── index.ts          # 要約インターフェース
│   ├── rule-based.ts     # ルールベース要約
│   └── webgpu.ts         # WebGPU推論（オプション）
│
└── infra/                # インフラ・ユーティリティ
    ├── uuid.ts           # UUID生成
    └── logger.ts         # ロガー（本文除外）
```

### 責務分離の原則
- `ui/`: 表示とユーザー操作のみ
- `domain/`: ビジネスロジック、型定義
- `db/`: IndexedDBアクセス
- `llm/`: 要約生成（実装差し替え可能に）
- `infra/`: 横断的関心事

---

## 9. リスクと対策（MVPで現実的なもののみ）

### WebGPU対応状況・端末差

| リスク | 影響度 | 対策 |
|--------|--------|------|
| WebGPU非対応端末が多い | 高 | ルールベース要約をデフォルトに |
| Safari/Firefoxで動作不安定 | 中 | 機能検出でフォールバック |

### ブラウザ差異

| リスク | 影響度 | 対策 |
|--------|--------|------|
| IndexedDB挙動差 | 中 | Dexieで吸収 |
| PWAインストール体験差 | 低 | 最小限の案内に留める |

### 推論が重い場合

| リスク | 影響度 | 対策 |
|--------|--------|------|
| UIフリーズ | 高 | Web Worker で実行 |
| メモリ枯渇 | 中 | 小型モデル選定、タイムアウト |

### IndexedDB容量・破損

| リスク | 影響度 | 対策 |
|--------|--------|------|
| ストレージ上限到達 | 低 | エラーハンドリング、ユーザー通知 |
| データ破損 | 中 | MVP後にバックアップ機能検討 |

### PWA更新時の不整合

| リスク | 影響度 | 対策 |
|--------|--------|------|
| キャッシュと新版の不整合 | 中 | `registerType: 'prompt'` で更新確認 |
| 更新後のDB移行失敗 | 中 | Dexie バージョン管理で対応 |

---

## 10. 実装優先順

### フェーズ1: 技術リスク検証（Week 1）
1. **ルールベース要約の実装** - 確実に動作するベースライン
2. **IndexedDB（Dexie）のCRUD** - Entry の保存・取得
3. **基本画面遷移** - 一覧 → 新規作成 → 詳細

### フェーズ2: コア機能実装（Week 2）
4. **エントリ編集・削除**
5. **要約表示の統合**
6. **PWA設定（オフライン動作）**

### フェーズ3: 安定化（Week 3）
7. **エラーハンドリング強化**
8. **設定画面（最小）**
9. **UIブラッシュアップ**

### フェーズ4: オプション・仕上げ（Week 4）
10. **WebGPU要約（対応端末向け）** ※時間があれば
11. **E2E動作確認**
12. **ドキュメント整備**

---

## 11. 次フェーズ（MVP後）の拡張余地

以下はMVPに含めないが、設計上の境界として考慮する。

### 暗号化バックアップ
- IndexedDB データを暗号化してエクスポート
- ユーザー指定のパスワードで暗号化
- インポート時に復号

### PDFエクスポート
- 選択した期間のエントリをPDF化
- jsPDF または同等ライブラリ

### モデル切り替え
- 複数のローカルLLMモデルから選択
- モデルファイルのダウンロード管理

### B2B / ホワイトラベル展開
- ブランディングのカスタマイズ
- 組織単位でのデプロイ
- （認証・同期は別テンプレートで対応）

---

## 12. MVP DoD（Definition of Done）

- [ ] Must要件がすべて満たされている
  - [ ] IndexedDBで日記入力・保存（オフライン）
  - [ ] 日付ごとのログ管理
  - [ ] 端末内での簡易要約（ルールベース以上）
  - [ ] PWA対応（オフライン利用可能）
  - [ ] 外部送信しない設計
- [ ] オフラインで主要機能が一通り動作する
- [ ] 日記本文・要約が外部送信されない
- [ ] 致命的なエラーなく利用できる
- [ ] Chrome, Safari, Firefox 最新版で動作確認済み
- [ ] Lighthouse PWAスコア 90以上

---

## 付録: 技術スタック候補

| 領域 | 候補 | 備考 |
|------|------|------|
| フレームワーク | React 18+ | 既存テンプレート準拠 |
| ビルド | Vite | 既存テンプレート準拠 |
| IndexedDB | Dexie.js | 型安全、移行管理 |
| PWA | vite-plugin-pwa | Workbox統合 |
| スタイリング | CSS Modules or Tailwind | 未確定、軽量優先 |
| WebGPU推論 | transformers.js | 候補（MVP後に詳細検討） |
| ルールベース要約 | 自前実装 | 依存なし |
| テスト | Vitest + Testing Library | 既存CI対応 |
